<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planning - {{ monday }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      .loading { animation: pulse 0.9s ease-in-out infinite; }
      @keyframes pulse { 0% { background-color: #fff; } 50% { background-color: #f1f5f9; } 100% { background-color: #fff; } }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-baseline mb-3">
        <div>
          <h1 class="h5 mb-1">Planning semaine du lundi {{ monday }}</h1>
          <div class="text-muted small">La liste de courses couvre tous les ingrédients prévus pour la semaine.</div>
        </div>
        <a class="text-decoration-none" href="/meal-planning/">Retour à la liste</a>
      </div>

      <div class="row g-3">
        <div class="col-12 col-lg-8">
          <div class="card shadow-sm">
            <div class="card-body">
              <div id="err" class="text-danger small mb-2" style="display:none;"></div>
              <div class="accordion" id="planningAcc"></div>
              <div class="text-muted small mt-2">Le GET JSON est effectué via <code>/meal-planning/{{ monday }}</code>.</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6 mb-2">Liste de courses</h2>
              <p class="text-muted small mb-2">Affichée sur sa page dédiée. Si elle existe, un lien apparaît ci-dessous.</p>
              <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                <button class="btn btn-primary btn-sm" id="createList">Créer la liste de course</button>
                <span id="listLink" class="text-muted small" style="display:none;"></span>
              </div>
              <div class="text-muted small" id="ingredientsCount"></div>
              <div class="text-muted small mt-2">URL : <code>/meal-planning/{{ monday }}/shopping-list</code>.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="regenModal" tabindex="-1" aria-labelledby="regenModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="regenModalLabel">Nouvelle proposition (IA)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="regenMode" id="regenModeVeg" value="vegetarien" checked>
                <label class="form-check-label" for="regenModeVeg">végétarien de saison</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="regenMode" id="regenModeGourmand" value="gourmand">
                <label class="form-check-label" for="regenModeGourmand">gourmand</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="regenMode" id="regenModeInspire" value="inspire">
                <label class="form-check-label" for="regenModeInspire">inspiré</label>
              </div>
            </div>
            <div id="regenIngredientsWrap" class="mb-2" style="display:none;">
              <label class="form-label small" for="regenIngredients">Ingrédients obligatoires (séparés par des virgules)</label>
              <input type="text" class="form-control form-control-sm" id="regenIngredients" placeholder="ex: courge, lentilles, feta">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary btn-sm" id="regenConfirm">Proposer</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const monday = "{{ monday }}";
      const acc = document.getElementById("planningAcc");
      const err = document.getElementById("err");
      const listLink = document.getElementById("listLink");
      const createBtn = document.getElementById("createList");
      const ingredientsCount = document.getElementById("ingredientsCount");

      let allIngredients = [];
      let planningData = [];
      let currentOpenIdx = null;
      let mealieRecipes = [];
      let mealieMatches = new Map();
      let pendingRegenIdx = null;
      let pendingRegenRow = null;

      const MEALIE_MATCH_MAX_DISTANCE = 100;
      const MEALIE_MATCH_MAX_RATIO = 0.05;

      function normalizeIngredient(s) {
        return (s || "").trim();
      }

      function normalizeText(s) {
        return (s || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, " ")
          .trim();
      }

      function damerauLevenshtein(a, b) {
        const s = a || "";
        const t = b || "";
        const m = s.length;
        const n = t.length;
        if (!m) return n;
        if (!n) return m;
        const d = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));
        for (let i = 0; i <= m; i++) d[i][0] = i;
        for (let j = 0; j <= n; j++) d[0][j] = j;
        for (let i = 1; i <= m; i++) {
          for (let j = 1; j <= n; j++) {
            const cost = s[i - 1] === t[j - 1] ? 0 : 1;
            let val = Math.min(
              d[i - 1][j] + 1,
              d[i][j - 1] + 1,
              d[i - 1][j - 1] + cost
            );
            if (i > 1 && j > 1 && s[i - 1] === t[j - 2] && s[i - 2] === t[j - 1]) {
              val = Math.min(val, d[i - 2][j - 2] + cost);
            }
            d[i][j] = val;
          }
        }
        return d[m][n];
      }

      function getReceiptName(meal) {
        if (!meal || typeof meal !== "object") return "";
        const candidates = [
          meal.recette,
          meal.recette_name,
          meal.receipt,
          meal.receipt_name,
          meal.recipe,
          meal.recipe_name,
        ];
        for (const val of candidates) {
          if (typeof val !== "string") continue;
          const txt = val.trim();
          if (txt) return txt;
        }
        const plats = Array.isArray(meal.plats) ? meal.plats : [];
        if (typeof plats[0] === "string" && plats[0].trim()) {
          return plats[0].trim();
        }
        return "";
      }

      function findMealieMatch(name) {
        const target = normalizeText(name);
        if (!target) return null;
        let best = null;
        for (const recipe of mealieRecipes) {
          const candidateName = normalizeText(recipe && recipe.name ? recipe.name : "");
          if (!candidateName) continue;
          const dist = damerauLevenshtein(target, candidateName);
          const maxLen = Math.max(target.length, candidateName.length);
          const ratio = maxLen ? dist / maxLen : 1;
          if (dist > MEALIE_MATCH_MAX_DISTANCE || ratio > MEALIE_MATCH_MAX_RATIO) continue;
          if (!best || ratio < best.ratio || (ratio === best.ratio && dist < best.dist)) {
            best = { recipe, dist, ratio };
          }
        }
        return best;
      }

      function updateMealieMatchForIndex(idx) {
        const meal = planningData[idx];
        if (!meal) {
          mealieMatches.delete(idx);
          return;
        }
        const receiptName = getReceiptName(meal);
        if (!receiptName) {
          mealieMatches.delete(idx);
          return;
        }
        const match = findMealieMatch(receiptName);
        if (match) {
          mealieMatches.set(idx, match);
        } else {
          mealieMatches.delete(idx);
        }
      }

      function updateAllMealieMatches() {
        mealieMatches = new Map();
        planningData.forEach((_, idx) => updateMealieMatchForIndex(idx));
      }

      function getSelectedRegenMode() {
        const selected = document.querySelector('input[name="regenMode"]:checked');
        return selected ? selected.value : "vegetarien";
      }

      function openRegenModal(idx, rowEl) {
        pendingRegenIdx = idx;
        pendingRegenRow = rowEl || null;
        const modalEl = document.getElementById("regenModal");
        if (!modalEl) return;
        const veg = document.getElementById("regenModeVeg");
        if (veg) veg.checked = true;
        if (regenIngredientsInput) regenIngredientsInput.value = "";
        updateRegenIngredientsVisibility();
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      }

      function computeAllIngredients(planning) {
        const agg = new Set();
        for (const meal of planning) {
          const src = Array.isArray(meal.ingredients) ? meal.ingredients : [];
          for (const raw of src) {
            const ing = normalizeIngredient(raw);
            if (ing) agg.add(ing);
          }
        }
        allIngredients = [...agg].sort((a, b) => a.localeCompare(b, "fr"));
        if (ingredientsCount) {
          ingredientsCount.innerHTML = `<span class="fw-semibold">${allIngredients.length}</span> ingrédient(s) détecté(s) dans le planning.`;
        }
      }

      async function loadSavedListIfAny() {
        try {
          const r = await fetch(`/meal-planning/${encodeURIComponent(monday)}/shopping-list`, {
            headers: { "Accept": "application/json" }
          });
          if (r.status === 404) return;
          if (!r.ok) throw new Error("Impossible de charger la liste sauvegardée");
          const data = await r.json();
          const hasData = data && (Array.isArray(data.items) || Array.isArray(data.to_buy));
          if (!hasData) return;
          showListLink(`/meal-planning/${encodeURIComponent(monday)}/shopping-list`);
        } catch (e) {
          err.style.display = "block";
          err.textContent = "Liste sauvegardée non chargée: " + (e && e.message ? e.message : e);
        }
      }

      function ingredientPopoverContent(meal) {
        const src = Array.isArray(meal.courses) ? meal.courses : (Array.isArray(meal.ingredients) ? meal.ingredients : []);
        if (!src.length) return "<em>Aucun ingrédient</em>";
        return src.map(x => `• ${String(x)}`).join("<br/>");
      }

      function renderPlanning(planning, keepOpenIndex = null) {
        acc.innerHTML = "";
        const order = new Map([["lundi", 1], ["mardi", 2], ["mercredi", 3], ["jeudi", 4], ["vendredi", 5], ["samedi", 6], ["dimanche", 7]]);
        const display = planning.map((m, idx) => ({ meal: m, idx }));
        display.sort((a, b) => (order.get(a.meal.jour) || 999) - (order.get(b.meal.jour) || 999));
        const targetIdx = keepOpenIndex !== null ? keepOpenIndex : currentOpenIdx;
        if (keepOpenIndex !== null) currentOpenIdx = keepOpenIndex;

        display.forEach(({ meal, idx }, i) => {
          if ((meal.repas || "").toLowerCase() !== "soir") return;
          const itemId = `acc-${i}`;
          const ingId = `ing-${i}`;
          const card = document.createElement("div");
          card.className = "accordion-item";

          const header = document.createElement("h2");
          header.className = "accordion-header";
          header.id = `heading-${itemId}`;

          const btn = document.createElement("button");
          btn.className = "accordion-button collapsed";
          btn.type = "button";
          btn.setAttribute("data-bs-toggle", "collapse");
          btn.setAttribute("data-bs-target", `#${itemId}`);
          btn.addEventListener("click", () => { currentOpenIdx = idx; });
          btn.innerHTML = `<div class="me-2 fw-semibold text-capitalize">${meal.jour || ""}</div><div class="small text-muted">${(Array.isArray(meal.plats) ? meal.plats.join(", ") : "")}</div>`;

          header.appendChild(btn);
          card.appendChild(header);

          const body = document.createElement("div");
          body.id = itemId;
          body.className = "accordion-collapse collapse";
          body.setAttribute("data-bs-parent", "#planningAcc");

          const inner = document.createElement("div");
          inner.className = "accordion-body";

          const topRow = document.createElement("div");
          topRow.className = "d-flex flex-wrap gap-2 align-items-center mb-2";

          const badge = document.createElement("span");
          badge.className = "badge bg-secondary";
          badge.textContent = meal.repas || "";
          topRow.appendChild(badge);

          const dur = document.createElement("span");
          dur.className = "text-muted small";
          dur.textContent = meal.duree_preparation_minutes ? `${meal.duree_preparation_minutes} min` : "";
          topRow.appendChild(dur);

          const btnNew = document.createElement("button");
          btnNew.className = "btn btn-outline-primary btn-sm position-relative";
          btnNew.type = "button";
          btnNew.textContent = "Nouvelle proposition";
          const badgeAI = document.createElement("span");
          badgeAI.className = "position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger";
          badgeAI.textContent = "IA";
          badgeAI.innerHTML += '<span class="visually-hidden">IA</span>';
          btnNew.appendChild(badgeAI);
          btnNew.addEventListener("click", () => openRegenModal(idx, card));
          topRow.appendChild(btnNew);

          const btnMealie = document.createElement("button");
          btnMealie.className = "btn btn-outline-success btn-sm";
          btnMealie.type = "button";
          btnMealie.textContent = "Ajouter un plat aléatoire de Mealie";
          btnMealie.addEventListener("click", () => addRandomMealieDish(idx, card));
          topRow.appendChild(btnMealie);

          if (Array.isArray(mealieRecipes) && mealieRecipes.length) {
            const dropdownWrap = document.createElement("div");
            dropdownWrap.className = "dropdown";

            const dropdownBtn = document.createElement("button");
            dropdownBtn.className = "btn btn-outline-success btn-sm dropdown-toggle";
            dropdownBtn.type = "button";
            dropdownBtn.setAttribute("data-bs-toggle", "dropdown");
            dropdownBtn.setAttribute("aria-expanded", "false");
            dropdownBtn.textContent = "add with mealie";
            dropdownWrap.appendChild(dropdownBtn);

            const menu = document.createElement("div");
            menu.className = "dropdown-menu p-2";
            menu.style.maxHeight = "320px";
            menu.style.overflowY = "auto";

            const search = document.createElement("input");
            search.type = "text";
            search.className = "form-control form-control-sm mb-2";
            search.placeholder = "Rechercher une recette";
            menu.appendChild(search);

            const list = document.createElement("div");
            menu.appendChild(list);

            function buildList(filter) {
              list.innerHTML = "";
              const needle = normalizeText(filter || "");
              const items = mealieRecipes.filter((r) => {
                const name = normalizeText(r && r.name ? r.name : "");
                if (!name) return false;
                return !needle || name.includes(needle);
              });
              if (!items.length) {
                const empty = document.createElement("div");
                empty.className = "text-muted small";
                empty.textContent = "Aucun résultat";
                list.appendChild(empty);
                return;
              }
              items.forEach((r) => {
                const itemBtn = document.createElement("button");
                itemBtn.type = "button";
                itemBtn.className = "dropdown-item";
                itemBtn.textContent = r.name;
                itemBtn.addEventListener("click", () => {
                  const ok = confirm(`Ajouter la recette Mealie "${r.name}" à ce repas ?`);
                  if (!ok) return;
                  addMealieDish(idx, card, r);
                });
                list.appendChild(itemBtn);
              });
            }

            buildList("");
            search.addEventListener("input", (e) => buildList(e.target.value));
            menu.addEventListener("click", (e) => e.stopPropagation());

            dropdownWrap.appendChild(menu);
            topRow.appendChild(dropdownWrap);
          }

          inner.appendChild(topRow);

          const plats = Array.isArray(meal.plats) ? meal.plats : [];
          const restes = Array.isArray(meal.restes) ? meal.restes : [];
          const ingredients = Array.isArray(meal.ingredients) ? meal.ingredients : [];

          function section(title, items, isPlat) {
            const wrap = document.createElement("div");
            wrap.className = "mb-2";
            const h = document.createElement("div");
            h.className = "fw-semibold";
            h.textContent = title;
            wrap.appendChild(h);
            const content = document.createElement("div");
            content.className = "text-muted small";
              if (!items || !items.length) {
                content.textContent = "—";
              } else {
                items.forEach((it) => {
                  const row = document.createElement("div");
                  if (isPlat) {
                    row.className = "d-flex align-items-center justify-content-between";
                  }
                  const left = document.createElement("span");
                  if (isPlat && meal.mealie_slug) {
                    const a = document.createElement("a");
                    const base = "{{ mealie_url }}";
                    a.href = `${base}/g/home/r/${encodeURIComponent(meal.mealie_slug)}`;
                    a.target = "_blank";
                    a.rel = "noopener noreferrer";
                    a.textContent = String(it);
                    left.textContent = "• ";
                    left.appendChild(a);
                  } else if (isPlat) {
                    const a = document.createElement("a");
                    a.href = "https://www.google.com/search?q=" + encodeURIComponent(String(it));
                    a.target = "_blank";
                    a.rel = "noopener noreferrer";
                    a.textContent = String(it);
                    left.textContent = "• ";
                    left.appendChild(a);
                  } else {
                    left.textContent = "• " + String(it);
                  }
                  row.appendChild(left);
                  if (isPlat) {
                    const del = document.createElement("button");
                    del.type = "button";
                    del.className = "btn btn-link btn-sm text-danger p-0 ms-2";
                    del.setAttribute("aria-label", `Supprimer ${String(it)}`);
                    del.textContent = "×";
                    del.addEventListener("click", () => removeDish(idx, String(it)));
                    row.appendChild(del);
                  }
                  content.appendChild(row);
                });
              }
            wrap.appendChild(content);
            return wrap;
          }

          inner.appendChild(section("Plats", plats, true));
          inner.appendChild(section("Restes", restes, false));
          inner.appendChild(section("Ingrédients", ingredients, false));

          body.appendChild(inner);
          card.appendChild(body);
          acc.appendChild(card);

          if (targetIdx !== null && targetIdx === idx) {
            const collapse = new bootstrap.Collapse(body, { toggle: false });
            collapse.show();
          }
        });

        // Activer les popovers
        const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        popoverTriggerList.forEach(el => new bootstrap.Popover(el));
      }

      async function persistCurrentList() {
        if (!allIngredients.length) {
          err.style.display = "block";
          err.textContent = "Aucun ingrédient à sauvegarder.";
          return null;
        }
        err.style.display = "none";
        const url = `/meal-planning/${encodeURIComponent(monday)}/shopping-list`;
        const r = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items: allIngredients })
        });
        if (!r.ok) {
          let detail = r.status;
          try {
            const payload = await r.json();
            if (payload && payload.detail) detail = payload.detail;
          } catch (_) {}
          throw new Error("Sauvegarde impossible: " + detail);
        }
        showListLink(url);
        return url;
      }

      function showListLink(url) {
        if (!listLink) return;
        listLink.style.display = "inline";
        listLink.innerHTML = `Liste existante : <a href="${url}">${location.origin}${url}</a>`;
        if (createBtn) createBtn.style.display = "none";
      }

      async function regenerateMeal(idx, rowEl, mode, ingredients) {
        err.style.display = "none";
        const meal = planningData[idx];
        if (!meal) return;
        if (rowEl) rowEl.classList.add("loading");
        try {
          const r = await fetch(`/meal-planning/${encodeURIComponent(monday)}/regenerate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ jour: meal.jour, repas: meal.repas, mode: mode || "vegetarien", ingredients })
          });
          if (!r.ok) {
            let detail = r.status;
            try {
              const payload = await r.json();
              if (payload && payload.detail) detail = payload.detail;
            } catch (_) {}
            throw new Error(detail);
          }
          const resp = await r.json();
          const newMeal = resp.meal || resp;
          planningData[idx] = newMeal;
          updateMealieMatchForIndex(idx);
          renderPlanning(planningData, idx);
          computeAllIngredients(planningData);
        } catch (e) {
          err.style.display = "block";
          err.textContent = "Génération impossible: " + (e && e.message ? e.message : e);
        } finally {
          if (rowEl) rowEl.classList.remove("loading");
        }
      }

      async function addRandomMealieDish(idx, rowEl) {
        err.style.display = "none";
        const meal = planningData[idx];
        if (!meal) return;
        if (rowEl) rowEl.classList.add("loading");
        try {
          const r = await fetch(`/meal-planning/${encodeURIComponent(monday)}/regenerate-mealie`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ jour: meal.jour, repas: meal.repas })
          });
          if (!r.ok) {
            let detail = r.status;
            try {
              const payload = await r.json();
              if (payload && payload.detail) detail = payload.detail;
            } catch (_) {}
            throw new Error(detail);
          }
          const resp = await r.json();
          const newMeal = resp.meal || resp;
          planningData[idx] = newMeal;
          updateMealieMatchForIndex(idx);
          renderPlanning(planningData, idx);
          computeAllIngredients(planningData);
        } catch (e) {
          err.style.display = "block";
          err.textContent = "Ajout impossible: " + (e && e.message ? e.message : e);
        } finally {
          if (rowEl) rowEl.classList.remove("loading");
        }
      }

      async function addMealieDish(idx, rowEl, recipe) {
        err.style.display = "none";
        const meal = planningData[idx];
        if (!meal || !recipe || !recipe.slug) return;
        if (rowEl) rowEl.classList.add("loading");
        try {
          const r = await fetch(`/meal-planning/${encodeURIComponent(monday)}/add-mealie-dish`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ jour: meal.jour, repas: meal.repas, slug: recipe.slug, name: recipe.name })
          });
          if (!r.ok) {
            let detail = r.status;
            try {
              const payload = await r.json();
              if (payload && payload.detail) detail = payload.detail;
            } catch (_) {}
            throw new Error(detail);
          }
          const resp = await r.json();
          const newMeal = resp.meal || resp;
          planningData[idx] = newMeal;
          updateMealieMatchForIndex(idx);
          renderPlanning(planningData, idx);
          computeAllIngredients(planningData);
        } catch (e) {
          err.style.display = "block";
          err.textContent = "Ajout impossible: " + (e && e.message ? e.message : e);
        } finally {
          if (rowEl) rowEl.classList.remove("loading");
        }
      }

      async function removeDish(idx, dish) {
        err.style.display = "none";
        const meal = planningData[idx];
        if (!meal || !dish) return;
        try {
          const r = await fetch(`/meal-planning/${encodeURIComponent(monday)}/remove-dish`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ jour: meal.jour, repas: meal.repas, dish })
          });
          if (!r.ok) {
            let detail = r.status;
            try {
              const payload = await r.json();
              if (payload && payload.detail) detail = payload.detail;
            } catch (_) {}
            throw new Error(detail);
          }
          const resp = await r.json();
          const newMeal = resp.meal || resp;
          planningData[idx] = newMeal;
          updateMealieMatchForIndex(idx);
          renderPlanning(planningData, idx);
          computeAllIngredients(planningData);
        } catch (e) {
          err.style.display = "block";
          err.textContent = "Suppression impossible: " + (e && e.message ? e.message : e);
        }
      }

      async function loadMealieRecipes() {
        try {
          const r = await fetch(`/mealie/recipes`, { headers: { "Accept": "application/json" } });
          if (!r.ok) throw new Error("GET Mealie failed: " + r.status);
          const data = await r.json();
          if (!Array.isArray(data)) throw new Error("Invalid Mealie JSON");
          mealieRecipes = data;
        } catch (e) {
          mealieRecipes = [];
        }
      }

      createBtn.addEventListener("click", async () => {
        try {
          await persistCurrentList();
        } catch (e) {
          err.style.display = "block";
          err.textContent = String(e && e.message ? e.message : e);
        }
      });

      const regenModalEl = document.getElementById("regenModal");
      const regenIngredientsWrap = document.getElementById("regenIngredientsWrap");
      const regenIngredientsInput = document.getElementById("regenIngredients");
      const regenConfirmBtn = document.getElementById("regenConfirm");
      const regenModeInputs = document.querySelectorAll('input[name="regenMode"]');

      function updateRegenIngredientsVisibility() {
        const mode = getSelectedRegenMode();
        if (regenIngredientsWrap) {
          regenIngredientsWrap.style.display = mode === "inspire" ? "block" : "none";
        }
        if (mode !== "inspire" && regenIngredientsInput) {
          regenIngredientsInput.value = "";
        }
      }

      regenModeInputs.forEach((input) => {
        input.addEventListener("change", updateRegenIngredientsVisibility);
      });
      updateRegenIngredientsVisibility();

      if (regenConfirmBtn) {
        regenConfirmBtn.addEventListener("click", () => {
          if (pendingRegenIdx === null) return;
          const mode = getSelectedRegenMode();
          const ingredients = mode === "inspire" && regenIngredientsInput ? regenIngredientsInput.value : "";
          if (regenModalEl) {
            const modal = bootstrap.Modal.getInstance(regenModalEl);
            if (modal) modal.hide();
          }
          regenerateMeal(pendingRegenIdx, pendingRegenRow, mode, ingredients);
          pendingRegenIdx = null;
          pendingRegenRow = null;
        });
      }

      async function main() {
        try {
          const r = await fetch(`/meal-planning/${encodeURIComponent(monday)}`, {
            headers: { "Accept": "application/json" }
          });
          if (!r.ok) throw new Error("GET JSON failed: " + r.status);
          planningData = await r.json();
          if (!Array.isArray(planningData)) throw new Error("Invalid JSON: not an array");
          await loadMealieRecipes();
          updateAllMealieMatches();
          renderPlanning(planningData);
          computeAllIngredients(planningData);
          await loadSavedListIfAny();
        } catch (e) {
          err.style.display = "block";
          err.textContent = String(e && e.message ? e.message : e);
        }
      }

      main();
    </script>
  </body>
</html>
