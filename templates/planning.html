<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planning - {{ monday }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      .loading { animation: pulse 0.9s ease-in-out infinite; }
      @keyframes pulse { 0% { background-color: #fff; } 50% { background-color: #f1f5f9; } 100% { background-color: #fff; } }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-baseline mb-3">
        <div>
          <h1 class="h5 mb-1">Planning semaine du lundi {{ monday }}</h1>
          <div class="text-muted small">La liste de courses couvre tous les ingrédients prévus pour la semaine.</div>
        </div>
        <a class="text-decoration-none" href="/meal-planning/">Retour à la liste</a>
      </div>

      <div class="row g-3">
        <div class="col-12 col-lg-8">
          <div class="card shadow-sm">
            <div class="card-body">
              <div id="err" class="text-danger small mb-2" style="display:none;"></div>
              <div class="accordion" id="planningAcc"></div>
              <div class="text-muted small mt-2">Le GET JSON est effectué via <code>/meal-planning/{{ monday }}</code>.</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6 mb-2">Liste de courses</h2>
              <p class="text-muted small mb-2">Affichée sur sa page dédiée. Si elle existe, un lien apparaît ci-dessous.</p>
              <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                <button class="btn btn-primary btn-sm" id="createList">Créer la liste de course</button>
                <span id="listLink" class="text-muted small" style="display:none;"></span>
              </div>
              <div class="text-muted small" id="ingredientsCount"></div>
              <div class="text-muted small mt-2">URL : <code>/meal-planning/{{ monday }}/shopping-list</code>.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const monday = "{{ monday }}";
      const acc = document.getElementById("planningAcc");
      const err = document.getElementById("err");
      const listLink = document.getElementById("listLink");
      const createBtn = document.getElementById("createList");
      const ingredientsCount = document.getElementById("ingredientsCount");

      let allIngredients = [];
      let planningData = [];
      let currentOpenIdx = null;

      function normalizeIngredient(s) {
        return (s || "").trim();
      }

      function computeAllIngredients(planning) {
        const agg = new Set();
        for (const meal of planning) {
          const src = Array.isArray(meal.courses) ? meal.courses : (Array.isArray(meal.ingredients) ? meal.ingredients : []);
          for (const raw of src) {
            const ing = normalizeIngredient(raw);
            if (ing) agg.add(ing);
          }
        }
        allIngredients = [...agg].sort((a, b) => a.localeCompare(b, "fr"));
        if (ingredientsCount) {
          ingredientsCount.innerHTML = `<span class="fw-semibold">${allIngredients.length}</span> ingrédient(s) détecté(s) dans le planning.`;
        }
      }

      async function loadSavedListIfAny() {
        try {
          const r = await fetch(`/meal-planning/${encodeURIComponent(monday)}/shopping-list`, {
            headers: { "Accept": "application/json" }
          });
          if (r.status === 404) return;
          if (!r.ok) throw new Error("Impossible de charger la liste sauvegardée");
          const data = await r.json();
          const hasData = data && (Array.isArray(data.items) || Array.isArray(data.to_buy));
          if (!hasData) return;
          showListLink(`/meal-planning/${encodeURIComponent(monday)}/shopping-list`);
        } catch (e) {
          err.style.display = "block";
          err.textContent = "Liste sauvegardée non chargée: " + (e && e.message ? e.message : e);
        }
      }

      function ingredientPopoverContent(meal) {
        const src = Array.isArray(meal.courses) ? meal.courses : (Array.isArray(meal.ingredients) ? meal.ingredients : []);
        if (!src.length) return "<em>Aucun ingrédient</em>";
        return src.map(x => `• ${String(x)}`).join("<br/>");
      }

      function renderPlanning(planning, keepOpenIndex = null) {
        acc.innerHTML = "";
        const order = new Map([["lundi", 1], ["mardi", 2], ["mercredi", 3], ["jeudi", 4], ["vendredi", 5], ["samedi", 6], ["dimanche", 7]]);
        const display = planning.map((m, idx) => ({ meal: m, idx }));
        display.sort((a, b) => (order.get(a.meal.jour) || 999) - (order.get(b.meal.jour) || 999));
        const targetIdx = keepOpenIndex !== null ? keepOpenIndex : currentOpenIdx;
        if (keepOpenIndex !== null) currentOpenIdx = keepOpenIndex;

        display.forEach(({ meal, idx }, i) => {
          if ((meal.repas || "").toLowerCase() !== "soir") return;
          const itemId = `acc-${i}`;
          const ingId = `ing-${i}`;
          const card = document.createElement("div");
          card.className = "accordion-item";

          const header = document.createElement("h2");
          header.className = "accordion-header";
          header.id = `heading-${itemId}`;

          const btn = document.createElement("button");
          btn.className = "accordion-button collapsed";
          btn.type = "button";
          btn.setAttribute("data-bs-toggle", "collapse");
          btn.setAttribute("data-bs-target", `#${itemId}`);
          btn.addEventListener("click", () => { currentOpenIdx = idx; });
          btn.innerHTML = `<div class="me-2 fw-semibold text-capitalize">${meal.jour || ""}</div><div class="small text-muted">${(Array.isArray(meal.plats) ? meal.plats.join(", ") : "")}</div>`;

          header.appendChild(btn);
          card.appendChild(header);

          const body = document.createElement("div");
          body.id = itemId;
          body.className = "accordion-collapse collapse";
          body.setAttribute("data-bs-parent", "#planningAcc");

          const inner = document.createElement("div");
          inner.className = "accordion-body";

          const topRow = document.createElement("div");
          topRow.className = "d-flex flex-wrap gap-2 align-items-center mb-2";

          const badge = document.createElement("span");
          badge.className = "badge bg-secondary";
          badge.textContent = meal.repas || "";
          topRow.appendChild(badge);

          const dur = document.createElement("span");
          dur.className = "text-muted small";
          dur.textContent = meal.duree_preparation_minutes ? `${meal.duree_preparation_minutes} min` : "";
          topRow.appendChild(dur);

          const btnNew = document.createElement("button");
          btnNew.className = "btn btn-outline-primary btn-sm";
          btnNew.type = "button";
          btnNew.textContent = "Nouveau repas";
          btnNew.addEventListener("click", () => regenerateMeal(idx, card));
          topRow.appendChild(btnNew);

          const btnIng = document.createElement("button");
          btnIng.className = "btn btn-outline-secondary btn-sm";
          btnIng.type = "button";
          btnIng.textContent = "Ingrédients";
          btnIng.setAttribute("data-bs-toggle", "popover");
          btnIng.setAttribute("data-bs-html", "true");
          btnIng.setAttribute("data-bs-content", ingredientPopoverContent(meal));
          topRow.appendChild(btnIng);

          inner.appendChild(topRow);

          const plats = Array.isArray(meal.plats) ? meal.plats : [];
          const restes = Array.isArray(meal.restes) ? meal.restes : [];
          const ingredients = Array.isArray(meal.ingredients) ? meal.ingredients : (Array.isArray(meal.courses) ? meal.courses : []);

          function section(title, items, isPlat) {
            const wrap = document.createElement("div");
            wrap.className = "mb-2";
            const h = document.createElement("div");
            h.className = "fw-semibold";
            h.textContent = title;
            wrap.appendChild(h);
            const content = document.createElement("div");
            content.className = "text-muted small";
            if (!items || !items.length) {
              content.textContent = "—";
            } else {
              items.forEach((it, idx) => {
                const row = document.createElement("div");
                if (isPlat) {
                  const a = document.createElement("a");
                  a.href = "https://www.google.com/search?q=" + encodeURIComponent(String(it));
                  a.target = "_blank";
                  a.rel = "noopener noreferrer";
                  a.textContent = String(it);
                  row.textContent = "• ";
                  row.appendChild(a);
                } else {
                  row.textContent = "• " + String(it);
                }
                content.appendChild(row);
              });
            }
            wrap.appendChild(content);
            return wrap;
          }

          inner.appendChild(section("Plats", plats, true));
          inner.appendChild(section("Restes", restes, false));
          inner.appendChild(section("Ingrédients", ingredients, false));

          body.appendChild(inner);
          card.appendChild(body);
          acc.appendChild(card);

          if (targetIdx !== null && targetIdx === idx) {
            const collapse = new bootstrap.Collapse(body, { toggle: false });
            collapse.show();
          }
        });

        // Activer les popovers
        const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        popoverTriggerList.forEach(el => new bootstrap.Popover(el));
      }

      async function persistCurrentList() {
        if (!allIngredients.length) {
          err.style.display = "block";
          err.textContent = "Aucun ingrédient à sauvegarder.";
          return null;
        }
        err.style.display = "none";
        const url = `/meal-planning/${encodeURIComponent(monday)}/shopping-list`;
        const r = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items: allIngredients })
        });
        if (!r.ok) {
          let detail = r.status;
          try {
            const payload = await r.json();
            if (payload && payload.detail) detail = payload.detail;
          } catch (_) {}
          throw new Error("Sauvegarde impossible: " + detail);
        }
        showListLink(url);
        return url;
      }

      function showListLink(url) {
        if (!listLink) return;
        listLink.style.display = "inline";
        listLink.innerHTML = `Liste existante : <a href="${url}">${location.origin}${url}</a>`;
        if (createBtn) createBtn.style.display = "none";
      }

      async function regenerateMeal(idx, rowEl) {
        err.style.display = "none";
        const meal = planningData[idx];
        if (!meal) return;
        if (rowEl) rowEl.classList.add("loading");
        try {
          const r = await fetch(`/meal-planning/${encodeURIComponent(monday)}/regenerate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ jour: meal.jour, repas: meal.repas })
          });
          if (!r.ok) {
            let detail = r.status;
            try {
              const payload = await r.json();
              if (payload && payload.detail) detail = payload.detail;
            } catch (_) {}
            throw new Error(detail);
          }
          const resp = await r.json();
          const newMeal = resp.meal || resp;
          planningData[idx] = newMeal;
          renderPlanning(planningData, idx);
          computeAllIngredients(planningData);
        } catch (e) {
          err.style.display = "block";
          err.textContent = "Génération impossible: " + (e && e.message ? e.message : e);
        } finally {
          if (rowEl) rowEl.classList.remove("loading");
        }
      }

      createBtn.addEventListener("click", async () => {
        try {
          await persistCurrentList();
        } catch (e) {
          err.style.display = "block";
          err.textContent = String(e && e.message ? e.message : e);
        }
      });

      async function main() {
        try {
          const r = await fetch(`/meal-planning/${encodeURIComponent(monday)}`, {
            headers: { "Accept": "application/json" }
          });
          if (!r.ok) throw new Error("GET JSON failed: " + r.status);
          planningData = await r.json();
          if (!Array.isArray(planningData)) throw new Error("Invalid JSON: not an array");
          renderPlanning(planningData);
          computeAllIngredients(planningData);
          await loadSavedListIfAny();
        } catch (e) {
          err.style.display = "block";
          err.textContent = String(e && e.message ? e.message : e);
        }
      }

      main();
    </script>
  </body>
</html>
