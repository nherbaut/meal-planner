<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Liste de courses</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background: #fafafa; }
      .wrap { max-width: 1100px; margin: 0 auto; }
      h1 { font-size: 20px; margin: 0 0 12px 0; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; align-items: start; }
      .card { border: 1px solid #e5e5e5; border-radius: 12px; padding: 14px; box-shadow: 0 1px 0 rgba(0,0,0,0.04); background: #fff; }
      .section-title { display: flex; justify-content: space-between; align-items: center; }
      .count { color: #333; font-weight: 600; font-size: 14px; }
      .muted { color: #666; font-size: 13px; }
      .row { display: flex; justify-content: space-between; align-items: center; gap: 8px; padding: 10px 12px; border: 1px solid #ededed; border-radius: 10px; background: #fdfdfd; margin-top: 8px; }
      .row span { flex: 1; }
      .btn { border: 1px solid #ddd; border-radius: 10px; padding: 8px 12px; cursor: pointer; font-size: 13px; }
      .btn.red { background: #ffe5e5; border-color: #e6b3b3; color: #a20000; }
      .btn.red:hover { background: #ffd6d6; }
      .btn.green { background: #e5f5e5; border-color: #b4dfb4; color: #1b5e20; }
      .btn.green:hover { background: #d4efda; }
      .empty { margin-top: 6px; }
      a { text-decoration: none; }
      a:hover { text-decoration: underline; }
      @media (max-width: 760px) { .grid { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Liste de courses - semaine du {{ monday }}</h1>
      <div id="err" class="muted" style="color:#b00020; display:none; margin-bottom:8px;"></div>
      <div class="grid">
        <div class="card">
          <div class="section-title">
            <h2 style="margin:0;font-size:16px;">À acheter</h2>
            <span class="count" id="toBuyCount">0</span>
          </div>
          <div id="toBuy"></div>
          <div class="muted empty" id="toBuyEmpty" style="display:none;">Rien à acheter.</div>
        </div>

        <div class="card">
          <div class="section-title">
            <h2 style="margin:0;font-size:16px;">Déjà acheté</h2>
            <span class="count" id="boughtCount">0</span>
          </div>
          <div id="bought"></div>
          <div class="muted empty" id="boughtEmpty" style="display:none;">Rien dans cette zone.</div>
        </div>
      </div>
      <div class="muted" style="margin-top:10px;"><a href="/meal-planning/{{ monday }}">Retour au planning</a></div>
    </div>

    <script>
      const monday = "{{ monday }}";
      const initialToBuy = {{ to_buy|tojson }};
      const initialBought = {{ bought|tojson }};
      const toBuyDiv = document.getElementById("toBuy");
      const boughtDiv = document.getElementById("bought");
      const toBuyEmpty = document.getElementById("toBuyEmpty");
      const boughtEmpty = document.getElementById("boughtEmpty");
      const toBuyCount = document.getElementById("toBuyCount");
      const boughtCount = document.getElementById("boughtCount");
      const err = document.getElementById("err");

      const toBuy = new Set();
      const bought = new Set();

      for (const it of initialToBuy || []) {
        const v = String(it || "").trim();
        if (v) toBuy.add(v);
      }
      for (const it of initialBought || []) {
        const v = String(it || "").trim();
        if (v) bought.add(v);
      }

      function setError(msg) {
        if (!err) return;
        if (!msg) {
          err.style.display = "none";
          err.textContent = "";
          return;
        }
        err.style.display = "block";
        err.textContent = msg;
      }

      function renderLists() {
        toBuyDiv.innerHTML = "";
        boughtDiv.innerHTML = "";

        const toBuyArr = [...toBuy].sort((a, b) => a.localeCompare(b, "fr"));
        const boughtArr = [...bought].sort((a, b) => a.localeCompare(b, "fr"));

        toBuyEmpty.style.display = toBuyArr.length ? "none" : "block";
        boughtEmpty.style.display = boughtArr.length ? "none" : "block";

        toBuyCount.textContent = `${toBuyArr.length}`;
        boughtCount.textContent = `${boughtArr.length}`;

        for (const ing of toBuyArr) {
          const row = document.createElement("div");
          row.className = "row";
          const span = document.createElement("span");
          span.textContent = ing;
          const btn = document.createElement("button");
          btn.className = "btn red";
          btn.type = "button";
          btn.textContent = "Acheté";
          btn.addEventListener("click", () => {
            toBuy.delete(ing);
            bought.add(ing);
            renderLists();
            persist();
          });
          row.appendChild(span);
          row.appendChild(btn);
          toBuyDiv.appendChild(row);
        }

        for (const ing of boughtArr) {
          const row = document.createElement("div");
          row.className = "row";
          const span = document.createElement("span");
          span.textContent = ing;
          const btn = document.createElement("button");
          btn.className = "btn green";
          btn.type = "button";
          btn.textContent = "À acheter";
          btn.addEventListener("click", () => {
            bought.delete(ing);
            toBuy.add(ing);
            renderLists();
            persist();
          });
          row.appendChild(span);
          row.appendChild(btn);
          boughtDiv.appendChild(row);
        }
      }

      renderLists();

      async function persist() {
        setError("");
        try {
          const payload = {
            to_buy: [...toBuy],
            bought: [...bought],
          };
          const r = await fetch(`/meal-planning/${encodeURIComponent(monday)}/shopping-list`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!r.ok) {
            let detail = r.status;
            try {
              const data = await r.json();
              if (data && data.detail) detail = data.detail;
            } catch (_) {}
            throw new Error(detail);
          }
        } catch (e) {
          setError("Sauvegarde impossible: " + (e && e.message ? e.message : e));
        }
      }
    </script>
  </body>
</html>
