<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Liste de courses - {{ monday }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-baseline mb-3">
        <h1 class="h5 mb-0">Liste de courses - semaine du {{ monday }}</h1>
        <a class="text-decoration-none" href="/meal-planning/{{ monday }}">Retour au planning</a>
      </div>
      <div id="err" class="text-danger small mb-2" style="display:none;"></div>
      <div class="d-flex align-items-center gap-2 mb-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="toggleView" />
          <label class="form-check-label" for="toggleView">Vue par jour</label>
        </div>
      </div>
      <div id="standardView" class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 mb-0">À acheter</h2>
                <span class="badge bg-primary" id="toBuyCount">0</span>
              </div>
              <div id="toBuy"></div>
              <div class="text-muted small mt-2" id="toBuyEmpty" style="display:none;">Rien à acheter.</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 mb-0">Déjà acheté</h2>
                <span class="badge bg-success" id="boughtCount">0</span>
              </div>
              <div id="bought"></div>
              <div class="text-muted small mt-2" id="boughtEmpty" style="display:none;">Rien dans cette zone.</div>
            </div>
          </div>
        </div>
      </div>

      <div id="perDayView" class="row g-3" style="display:none;">
        <div class="col-12">
          <div class="accordion" id="perDayAcc"></div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const monday = "{{ monday }}";
      const initialToBuy = {{ to_buy|tojson }};
      const initialBought = {{ bought|tojson }};
      const notes = {{ notes|tojson }};
      const toBuyDiv = document.getElementById("toBuy");
      const boughtDiv = document.getElementById("bought");
      const toBuyEmpty = document.getElementById("toBuyEmpty");
      const boughtEmpty = document.getElementById("boughtEmpty");
      const toBuyCount = document.getElementById("toBuyCount");
      const boughtCount = document.getElementById("boughtCount");
      const err = document.getElementById("err");
      const toggleView = document.getElementById("toggleView");
      const standardView = document.getElementById("standardView");
      const perDayView = document.getElementById("perDayView");
      const perDayAcc = document.getElementById("perDayAcc");
      const planningData = {{ planning|tojson }};

      const toBuy = new Set();
      const bought = new Set();

      for (const it of initialToBuy || []) {
        const v = String(it || "").trim();
        if (v) toBuy.add(v);
      }
      for (const it of initialBought || []) {
        const v = String(it || "").trim();
        if (v) bought.add(v);
      }

      function setError(msg) {
        if (!err) return;
        if (!msg) {
          err.style.display = "none";
          err.textContent = "";
          return;
        }
        err.style.display = "block";
        err.textContent = msg;
      }

      function renderLists() {
        toBuyDiv.innerHTML = "";
        boughtDiv.innerHTML = "";

        const toBuyArr = [...toBuy].sort((a, b) => a.localeCompare(b, "fr"));
        const boughtArr = [...bought].sort((a, b) => a.localeCompare(b, "fr"));

        toBuyEmpty.style.display = toBuyArr.length ? "none" : "block";
        boughtEmpty.style.display = boughtArr.length ? "none" : "block";

        toBuyCount.textContent = `${toBuyArr.length}`;
        boughtCount.textContent = `${boughtArr.length}`;

        for (const ing of toBuyArr) {
          const row = document.createElement("div");
          row.className = "d-flex align-items-center justify-content-between border rounded p-2 mb-2 bg-white";
          const span = document.createElement("span");
          span.className = "d-flex flex-column";
          const label = document.createElement("span");
          label.textContent = ing;
          span.appendChild(label);
          if (notes && notes[ing.toLowerCase()]) {
            const note = document.createElement("span");
            note.className = "text-muted small fst-italic";
            note.textContent = notes[ing.toLowerCase()];
            span.appendChild(note);
          }
          const btn = document.createElement("button");
          btn.className = "btn btn-sm btn-outline-danger";
          btn.type = "button";
          btn.textContent = "Acheté";
          btn.addEventListener("click", () => {
            toBuy.delete(ing);
            bought.add(ing);
            renderLists();
            persist();
          });
          row.appendChild(span);
          row.appendChild(btn);
          toBuyDiv.appendChild(row);
        }

        for (const ing of boughtArr) {
          const row = document.createElement("div");
          row.className = "d-flex align-items-center justify-content-between border rounded p-2 mb-2 bg-white";
          const span = document.createElement("span");
          span.className = "d-flex flex-column";
          const label = document.createElement("span");
          label.textContent = ing;
          span.appendChild(label);
          if (notes && notes[ing.toLowerCase()]) {
            const note = document.createElement("span");
            note.className = "text-muted small fst-italic";
            note.textContent = notes[ing.toLowerCase()];
            span.appendChild(note);
          }
          const btn = document.createElement("button");
          btn.className = "btn btn-sm btn-outline-success";
          btn.type = "button";
          btn.textContent = "À acheter";
          btn.addEventListener("click", () => {
            bought.delete(ing);
            toBuy.add(ing);
            renderLists();
            persist();
          });
          row.appendChild(span);
          row.appendChild(btn);
          boughtDiv.appendChild(row);
        }
      }

      renderLists();

      function renderPerDay() {
        perDayAcc.innerHTML = "";
        if (!Array.isArray(planningData) || planningData.length === 0) {
          perDayAcc.innerHTML = '<div class="text-muted small">Pas de planning chargé.</div>';
          return;
        }
        const order = new Map([["lundi", 1], ["mardi", 2], ["mercredi", 3], ["jeudi", 4], ["vendredi", 5], ["samedi", 6], ["dimanche", 7]]);
        const buySet = new Set([...toBuy].map(x => x.toLowerCase()));
        const boughtSet = new Set([...bought].map(x => x.toLowerCase()));
        const items = planningData
          .filter(m => (m.repas || "").toLowerCase() === "soir")
          .map((m, idx) => ({ meal: m, idx }))
          .sort((a, b) => (order.get((a.meal.jour || "").toLowerCase()) || 999) - (order.get((b.meal.jour || "").toLowerCase()) || 999));

        items.forEach(({ meal }, i) => {
          const itemId = `day-${i}`;
          const card = document.createElement("div");
          card.className = "accordion-item";

          const h = document.createElement("h2");
          h.className = "accordion-header";
          const btn = document.createElement("button");
          btn.className = "accordion-button collapsed";
          btn.type = "button";
          btn.setAttribute("data-bs-toggle", "collapse");
          btn.setAttribute("data-bs-target", `#${itemId}`);
          btn.innerHTML = `<div class="me-2 fw-semibold text-capitalize">${meal.jour || ""}</div><div class="small text-muted">${(Array.isArray(meal.plats) ? meal.plats.join(", ") : "")}</div>`;
          h.appendChild(btn);
          card.appendChild(h);

          const body = document.createElement("div");
          body.id = itemId;
          body.className = "accordion-collapse collapse";

          const inner = document.createElement("div");
          inner.className = "accordion-body";
          const ing = Array.isArray(meal.ingredients) ? meal.ingredients : (Array.isArray(meal.courses) ? meal.courses : []);
          if (!ing.length) {
            inner.innerHTML = '<div class="text-muted small">Aucun ingrédient.</div>';
          } else {
            ing.forEach(val => {
              const norm = String(val || "").toLowerCase();
              const row = document.createElement("div");
              row.className = "d-flex justify-content-between align-items-center border rounded p-2 mb-2";
              const left = document.createElement("div");
              left.className = "d-flex flex-column";
              const label = document.createElement("span");
              label.textContent = val;
              left.appendChild(label);
              if (notes && notes[norm]) {
                const note = document.createElement("span");
                note.className = "text-muted small fst-italic";
                note.textContent = notes[norm];
                left.appendChild(note);
              }
              const badge = document.createElement("span");
              if (boughtSet.has(norm)) {
                badge.className = "badge bg-success";
                badge.textContent = "Acheté";
              } else if (buySet.has(norm)) {
                badge.className = "badge bg-primary";
                badge.textContent = "À acheter";
              } else {
                badge.className = "badge bg-secondary";
                badge.textContent = "Non prévu";
              }
              row.appendChild(left);
              row.appendChild(badge);
              inner.appendChild(row);
            });
          }
          body.appendChild(inner);
          card.appendChild(body);
          perDayAcc.appendChild(card);
        });
      }

      toggleView.addEventListener("change", () => {
        if (toggleView.checked) {
          standardView.style.display = "none";
          perDayView.style.display = "flex";
          renderPerDay();
        } else {
          perDayView.style.display = "none";
          standardView.style.display = "flex";
        }
      });

      async function persist() {
        setError("");
        try {
          const payload = {
            to_buy: [...toBuy],
            bought: [...bought],
            notes: notes,
          };
          const r = await fetch(`/meal-planning/${encodeURIComponent(monday)}/shopping-list`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!r.ok) {
            let detail = r.status;
            try {
              const data = await r.json();
              if (data && data.detail) detail = data.detail;
            } catch (_) {}
            throw new Error(detail);
          }
        } catch (e) {
          setError("Sauvegarde impossible: " + (e && e.message ? e.message : e));
        }
      }
    </script>
  </body>
</html>
