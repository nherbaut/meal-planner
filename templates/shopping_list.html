<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Liste de courses - {{ monday }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-baseline mb-3">
        <h1 class="h5 mb-0">Liste de courses - semaine du {{ monday }}</h1>
        <a class="text-decoration-none" href="/meal-planning/{{ monday }}">Retour au planning</a>
      </div>
      <div id="err" class="text-danger small mb-2" style="display:none;"></div>
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 mb-0">À acheter</h2>
                <span class="badge bg-primary" id="toBuyCount">0</span>
              </div>
              <div id="toBuy"></div>
              <div class="text-muted small mt-2" id="toBuyEmpty" style="display:none;">Rien à acheter.</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 mb-0">Déjà acheté</h2>
                <span class="badge bg-success" id="boughtCount">0</span>
              </div>
              <div id="bought"></div>
              <div class="text-muted small mt-2" id="boughtEmpty" style="display:none;">Rien dans cette zone.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const monday = "{{ monday }}";
      const initialToBuy = {{ to_buy|tojson }};
      const initialBought = {{ bought|tojson }};
      const notes = {{ notes|tojson }};
      const toBuyDiv = document.getElementById("toBuy");
      const boughtDiv = document.getElementById("bought");
      const toBuyEmpty = document.getElementById("toBuyEmpty");
      const boughtEmpty = document.getElementById("boughtEmpty");
      const toBuyCount = document.getElementById("toBuyCount");
      const boughtCount = document.getElementById("boughtCount");
      const err = document.getElementById("err");

      const toBuy = new Set();
      const bought = new Set();

      for (const it of initialToBuy || []) {
        const v = String(it || "").trim();
        if (v) toBuy.add(v);
      }
      for (const it of initialBought || []) {
        const v = String(it || "").trim();
        if (v) bought.add(v);
      }

      function setError(msg) {
        if (!err) return;
        if (!msg) {
          err.style.display = "none";
          err.textContent = "";
          return;
        }
        err.style.display = "block";
        err.textContent = msg;
      }

      function renderLists() {
        toBuyDiv.innerHTML = "";
        boughtDiv.innerHTML = "";

        const toBuyArr = [...toBuy].sort((a, b) => a.localeCompare(b, "fr"));
        const boughtArr = [...bought].sort((a, b) => a.localeCompare(b, "fr"));

        toBuyEmpty.style.display = toBuyArr.length ? "none" : "block";
        boughtEmpty.style.display = boughtArr.length ? "none" : "block";

        toBuyCount.textContent = `${toBuyArr.length}`;
        boughtCount.textContent = `${boughtArr.length}`;

        for (const ing of toBuyArr) {
          const row = document.createElement("div");
          row.className = "d-flex align-items-center justify-content-between border rounded p-2 mb-2 bg-white";
          const span = document.createElement("span");
          span.className = "d-flex flex-column";
          const label = document.createElement("span");
          label.textContent = ing;
          span.appendChild(label);
          if (notes && notes[ing.toLowerCase()]) {
            const note = document.createElement("span");
            note.className = "text-muted small fst-italic";
            note.textContent = notes[ing.toLowerCase()];
            span.appendChild(note);
          }
          const btn = document.createElement("button");
          btn.className = "btn btn-sm btn-outline-danger";
          btn.type = "button";
          btn.textContent = "Acheté";
          btn.addEventListener("click", () => {
            toBuy.delete(ing);
            bought.add(ing);
            renderLists();
            persist();
          });
          row.appendChild(span);
          row.appendChild(btn);
          toBuyDiv.appendChild(row);
        }

        for (const ing of boughtArr) {
          const row = document.createElement("div");
          row.className = "d-flex align-items-center justify-content-between border rounded p-2 mb-2 bg-white";
          const span = document.createElement("span");
          span.className = "d-flex flex-column";
          const label = document.createElement("span");
          label.textContent = ing;
          span.appendChild(label);
          if (notes && notes[ing.toLowerCase()]) {
            const note = document.createElement("span");
            note.className = "text-muted small fst-italic";
            note.textContent = notes[ing.toLowerCase()];
            span.appendChild(note);
          }
          const btn = document.createElement("button");
          btn.className = "btn btn-sm btn-outline-success";
          btn.type = "button";
          btn.textContent = "À acheter";
          btn.addEventListener("click", () => {
            bought.delete(ing);
            toBuy.add(ing);
            renderLists();
            persist();
          });
          row.appendChild(span);
          row.appendChild(btn);
          boughtDiv.appendChild(row);
        }
      }

      renderLists();

      async function persist() {
        setError("");
        try {
          const payload = {
            to_buy: [...toBuy],
            bought: [...bought],
          };
          const r = await fetch(`/meal-planning/${encodeURIComponent(monday)}/shopping-list`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!r.ok) {
            let detail = r.status;
            try {
              const data = await r.json();
              if (data && data.detail) detail = data.detail;
            } catch (_) {}
            throw new Error(detail);
          }
        } catch (e) {
          setError("Sauvegarde impossible: " + (e && e.message ? e.message : e));
        }
      }
    </script>
  </body>
</html>
