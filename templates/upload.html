<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Charger un planning - {{ monday }}</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      .wrap { max-width: 980px; margin: 0 auto; }
      h1 { font-size: 20px; margin: 0 0 14px 0; }
      .card { border: 1px solid #e5e5e5; border-radius: 12px; padding: 16px; box-shadow: 0 1px 0 rgba(0,0,0,0.04); }
      textarea { width: 100%; min-height: 380px; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
      .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; margin-top: 10px; }
      button { padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; background: #f7f7f7; cursor: pointer; }
      button:hover { background: #efefef; }
      a { text-decoration: none; }
      a:hover { text-decoration: underline; }
      .msg { color: #b00020; font-size: 13px; margin-top: 8px; display: none; }
      .top { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; margin-bottom: 10px; }
      .sub { color: #555; font-size: 13px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <div>
          <h1>Charger un planning pour {{ monday }}</h1>
          <div class="sub">Aucun planning n’existe pour cette semaine. Coller le JSON puis envoyer.</div>
        </div>
        <div><a href="/meal-planning/">Retour à la liste</a></div>
      </div>

      <div class="card">
        <form id="f" method="post" action="/meal-planning/{{ monday }}">
          <textarea id="t" name="planning_json" placeholder='[{"jour":"lundi",...}]'></textarea>
          <div class="row">
            <button type="button" id="validate">Valider JSON</button>
            <button type="submit">Envoyer</button>
            <button type="button" id="generate">Générer automatiquement</button>
          </div>
          <div class="msg" id="msg"></div>
        </form>
      </div>
    </div>

    <script>
      const t = document.getElementById("t");
      const msg = document.getElementById("msg");
      const genBtn = document.getElementById("generate");

      function setMsg(text, isError) {
        msg.style.display = "block";
        msg.style.color = isError ? "#b00020" : "#1b5e20";
        msg.textContent = text;
      }

      document.getElementById("validate").addEventListener("click", () => {
        msg.style.display = "none";
        const raw = (t.value || "").trim();
        if (!raw) return setMsg("JSON vide.", true);
        try {
          const obj = JSON.parse(raw);
          if (!Array.isArray(obj)) return setMsg("Le JSON doit être un tableau.", true);
          return setMsg("JSON valide.", false);
        } catch (e) {
          return setMsg("JSON invalide: " + e.message, true);
        }
      });

      genBtn.addEventListener("click", async () => {
        msg.style.display = "none";
        genBtn.disabled = true;
        genBtn.textContent = "Génération…";
        try {
          const r = await fetch(`/meal-planning/${encodeURIComponent("{{ monday }}")}/generate-week`, {
            method: "POST",
          });
          if (!r.ok) {
            let detail = r.status;
            try {
              const payload = await r.json();
              if (payload && payload.detail) detail = payload.detail;
            } catch (_) {}
            throw new Error(detail);
          }
          window.location.href = `/meal-planning/${encodeURIComponent("{{ monday }}")}`;
        } catch (e) {
          setMsg("Génération impossible: " + (e && e.message ? e.message : e), true);
        } finally {
          genBtn.disabled = false;
          genBtn.textContent = "Générer automatiquement";
        }
      });
    </script>
  </body>
</html>
